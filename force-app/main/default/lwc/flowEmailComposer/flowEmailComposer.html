<template>
    <div class="slds-box" style="background:white;">
        <lightning-layout multipleRows="true">
            
            <lightning-layout-item size="12" class="slds-p-horizontal_small">
                <lightning-input value="{!v.toAddresses}" required="true" label="To:Specify comma separated e-mail addresses"></lightning-input>
            </lightning-layout-item>
            
            <template if:true={showCCButton}>
                <lightning-layout-item size="1" class="slds-p-horizontal_small">
                    <lightning-button variant="base" label="CC" onclick={showcc}></lightning-button>
                </lightning-layout-item>
            </aura:if>
            <template if:true={showBCCButton}>
                <lightning-layout-item size="1" class="slds-p-horizontal_small">
                    <lightning-button variant="base" label="Bcc" onclick={showbcc}/>
                </lightning-layout-item>
            </aura:if>
            <aura:if isTrue={showCCFieldFinal}>
                <lightning-layout-item size="12" class="slds-p-horizontal_small">
                    <lightning-input value={ccAddresses} required="true" label="CC: Specify comma separated e-mail addresses"/>
                </lightning-layout-item>
            </aura:if>
            <aura:if isTrue={showBCCFieldFinal}>
                <lightning-layout-item size="12" class="slds-p-horizontal_small">
                    <lightning-input value={bccAddresses} label="Bcc: Specify comma separated e-mail addresses" required="true"/>
                </lightning-layout-item>
            </aura:if>
            <lightning-layout-item size="12" class="slds-p-horizontal_small">
                <lightning-input name="subject" label="Subject" value={subject} required="true"/>
            </lightning-layout-item>

            <template if:false={hideTemplateSelection}>
                <lightning-layout-item size="12" class="slds-p-horizontal_small">
                    <lightning-combobox name="template" label="Select Email Template Folder:" aura:id="folderId" value={selFolderId} onchange="{!c.filterEmailTemplates}">
                        <option text="--Select an E-mail Template Folder--" value=""/>
                        <aura:iteration items="{!v.folders}" var="folder">
                            <option text="{!folder.Name}" value="{!folder.Id}"/>
                        </aura:iteration>
                    </lightning-combobox>
                </lightning-layout-item>
                <lightning-layout-item size="12" class="slds-p-horizontal_small">
                    <lightning-combobox name="template" label="Select a Template:" aura:id="templateId" value="{!v.selTemplateId}" onchange="{!c.changeBody}">
                        <option text="--Select a Template--" value=""/>
                        <aura:iteration items="{!v.filteredTemplateList}" var="option">
                            <option text="{!option.Name}" value="{!option.Id}"/>
                        </aura:iteration>
                    </lightning-combobox>
                </lightning-layout-item>
            </aura:if>
            
            
            <lightning-layout-item size="12" class="slds-p-horizontal_small">
                <label class="slds-form-element__label"><abbr class="slds-required" title="required">* </abbr>Body
                </label>
                <lightning-inputRichText label="Body" value="{!v.emailBody}"/>
            </lightning-layout-item>
            <aura:if isTrue="{!not(empty(v.attachmentsFromTemplate))}">
                <lightning-layout-item size="12" class="slds-p-horizontal_small">
                    <label class="slds-form-element__label">Attached Files from Template:</label>
                    <aura:iteration items="{!v.attachmentsFromTemplate}" var="att"> 
                        <lightning:pill class="pillcss" name="{!att.attachId}" label="{!(att.fileName)}" onremove="{!c.removeAtt}"/>
                    </aura:iteration> 
                </lightning-layout-item>
            </aura:if>
            <lightning-layout-item size="12" class="slds-p-horizontal_small">
                <label class="slds-form-element__label">Attach New Files:</label>
                <lightning:fileUpload label="" multiple="true"
                                      recordId="{!v.uploadRefId}"
                                      onuploadfinished="{!c.UploadFinished}" /> 
            </lightning-layout-item>
            <lightning-layout-item size="12" class="slds-p-horizontal_small">
                <aura:iteration items="{!v.filesTobeAttached}" var="f"> 
                    <lightning:pill class="pillcss" name="{!f.documentId}" label="{!(f.name)}" onremove="{!c.delFiles}"
                                    onclick="{!c.previewFile}"/>
                </aura:iteration> 
                <aura:if isTrue="{!v.showSpinner}">
                    <lightning:spinner alternativeText="Loading" size="medium" />
                </aura:if>
            </lightning-layout-item>
            <lightning-layout-item size="12" class="slds-p-around_small">
                <lightning-button disabled="{!(empty(v.toAddresses) || empty(v.subject) || empty(v.emailBody))}" class="slds-button slds-button_brand slds-align_absolute-center" label="Send" onclick="{!c.sendEmail}"/>
            </lightning-layout-item>
        </lightning:layout>
    </div>
    <!-- File Preview -->
    <aura:if isTrue="{!v.hasModalOpen}">
        <section onclick="{!c.closeModel}"
                 role="dialog"
                 aria-modal="true"
                 class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <div class="slds-modal__content slds-p-around_medium slds-text-align_center"
                     style="background: transparent;">
                    <div style="width: 50%; margin: 0 auto; text-align: left">
                        <lightning:fileCard fileId="{!v.selectedDocumentId}"/>
                    </div>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </aura:if>
    
</template>