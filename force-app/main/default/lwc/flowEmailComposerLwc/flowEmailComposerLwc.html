<template>
  <template if:true={showSpinner}>
    <lightning-spinner size="large" alternative-text="loading..."></lightning-spinner>
  </template>
  <div class="slds-box" style="background: white">
    <lightning-layout multiple-rows>
      <lightning-layout-item size="12" class="slds-p-horizontal_small">
        <c-lookup
          onsearch={handleContactSearch}
          onselectionchange={handleWhoIdChange}
          label="To: Contact"
          placeholder="Select a contact to send the email to"
        ></c-lookup>
      </lightning-layout-item>
      <lightning-layout-item size="12" class="slds-p-horizontal_small">
        <lightning-input
          value={toAddresses}
          required="true"
          label="To:Specify comma separated e-mail addresses"
          onchange={handleToAddressesChange}
        ></lightning-input>
      </lightning-layout-item>
      <template if:true={showCCButton}>
        <lightning-layout-item size="1" class="slds-p-horizontal_small">
          <lightning-button variant="base" label="CC" onclick={showcc}></lightning-button>
        </lightning-layout-item>
      </template>
      <template if:true={showBCCButton}>
        <lightning-layout-item size="1" class="slds-p-horizontal_small">
          <lightning-button variant="base" label="Bcc" onclick={showbcc}></lightning-button>
        </lightning-layout-item>
      </template>
      <template if:true={showCCFieldFinal}>
        <lightning-layout-item size="12" class="slds-p-horizontal_small">
          <lightning-input
            value={ccAddresses}
            required="true"
            label="CC: Specify comma separated e-mail addresses"
            onchange={handleCCAddressesChange}
          ></lightning-input>
        </lightning-layout-item>
      </template>
      <template if:true={showBCCFieldFinal}>
        <lightning-layout-item size="12" class="slds-p-horizontal_small">
          <lightning-input
            value={bccAddresses}
            label="Bcc: Specify comma separated e-mail addresses"
            required="true"
            onchange={handleBCCAddressesChange}
          ></lightning-input>
        </lightning-layout-item>
      </template>
      <lightning-layout-item size="12" class="slds-p-horizontal_small">
        <lightning-input
          name="subject"
          label="Subject"
          value={subject}
          required="true"
          onchange={handleSubjectChange}
        ></lightning-input>
      </lightning-layout-item>

      <template if:false={hideTemplateSelection}>
        <lightning-layout-item size="12" class="slds-p-horizontal_small">
          <lightning-combobox
            options={folders}
            name="template"
            label="Select Email Template Folder:"
            value={selFolderId}
            onchange={handleTemplateFolderChange}
          >
          </lightning-combobox>
        </lightning-layout-item>
        <lightning-layout-item size="12" class="slds-p-horizontal_small">
          <lightning-combobox
            name="template"
            label="Select a Template:"
            value={selTemplateId}
            onchange={changeBody}
            options={filteredTemplateList}
          >
          </lightning-combobox>
        </lightning-layout-item>
      </template>

      <lightning-layout-item size="12" class="slds-p-horizontal_small">
        <label class="slds-form-element__label"><abbr class="slds-required" title="required">* </abbr>Body </label>
        <lightning-input-rich-text
          label="Body"
          value={emailBody}
          onchange={handleBodyChange}
        ></lightning-input-rich-text>
      </lightning-layout-item>
      <template if:true={hasTemplateAttachments}>
        <lightning-layout-item size="12" class="slds-p-horizontal_small">
          <label class="slds-form-element__label">Attached Files from Template:</label>
          <template for:each={attachmentsFromTemplate} for:item="att">
            <lightning-pill
              key={att.attachId}
              class="pillcss"
              name={att.attachId}
              label={att.fileName}
              onclick={previewFile}
              onremove={handleRemoveAttachment}
            ></lightning-pill>
          </template>
        </lightning-layout-item>
      </template>
      <lightning-layout-item size="12" class="slds-p-horizontal_small">
        <label class="slds-form-element__label">Attach New Files:</label>
        <lightning-file-upload
          label=""
          multiple="true"
          record-id={uploadRefId}
          onuploadfinished={uploadFinished}
        ></lightning-file-upload>
      </lightning-layout-item>
      <lightning-layout-item size="12" class="slds-p-horizontal_small">
        <template for:each={filesTobeAttached} for:item="f">
          <lightning-pill
            key={f.name}
            class="pillcss"
            name={f.documentId}
            label={f.name}
            onclick={previewFile}
            onremove={handleDeleteFile}
          ></lightning-pill>
        </template>
        <template if:true={showSpinner}>
          <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
        </template>
      </lightning-layout-item>
      <lightning-layout-item size="12" class="slds-p-around_small">
        <template if:true={showSendButton}>
          <lightning-button
            disabled={sendButtonDisabled}
            class="slds-align_absolute-center"
            variant="brand"
            label="Send"
            onclick={sendEmail}
          ></lightning-button>
        </template>
        <lightning-button
          class="slds-float_right"
          variant="brand"
          label="Next"
          onclick={handleGoNext}
        ></lightning-button>
      </lightning-layout-item>
    </lightning-layout>
  </div>
</template>
